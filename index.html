<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi Kajian</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-center p-4 font-sans">
  <div class="max-w-md bg-white p-6 rounded-xl shadow-md mx-auto">
    <h2 class="text-2xl font-semibold text-gray-800 mb-2">Absensi Hadir Kajian</h2>

    <p id="loadingNama" class="text-blue-600 font-bold mb-3">Memuat daftar nama...</p>

    <div class="relative w-full mb-3">
      <input type="text" id="namaUser" placeholder="Ketik & pilih nama dari daftar..." autocomplete="off"
        disabled
        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring focus:ring-blue-200 bg-white">
      <div id="autocomplete-list" class="absolute w-full bg-white border border-t-0 max-h-40 overflow-y-auto z-50 rounded-b-md"></div>
    </div>

    <p id="status" class="text-red-600 font-semibold mb-4">Menunggu lokasi...</p>

    <button id="absenBtn" disabled
      class="w-full p-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">Absen
      Sekarang</button>

    <button id="tidakHadirBtn" disabled
      class="w-full p-3 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors mt-2 disabled:bg-gray-400">Laporkan
      Ketidakhadiran</button>

    <button id="caraPenggunaanBtn" onclick="tampilkanAturan()"
      class="mt-4 text-blue-600 hover:underline text-sm">â„¹ï¸ Cara Penggunaan</button>

    <p id="hasilAbsen" class="mt-4 font-bold text-green-600"></p>
  </div>

  <script>
    function tampilkanAturan() {
      Swal.fire({
        icon: 'info',
        title: 'Cara Penggunaan',
        html: `
          <ul style="text-align: left;">
            <li>ğŸ“ <strong>Aktifkan GPS</strong> di perangkat Anda sebelum mulai menggunakan aplikasi.</li>
            <li>âœ… Pilih nama Anda dari daftar yang tersedia.</li>
            <li>âŒ Jika tidak memilih nama, tombol tidak bisa ditekan.</li>
            <li>ğŸ“Œ Pastikan nama yang diketik benar-benar sesuai dengan yang ada di sistem.</li>
          </ul>`
      });
    }

    let userLat, userLng;
    let namaList = [];

    function getNamaDariServer() {
      fetch("https://script.google.com/macros/s/AKfycbySsgyPpk2kfol3gWArn5nz0zCn6DnY_xeYqCxvDvwodNTO6xVR2cZ-jAGn0SQk5YFDxA/exec?type=getNama")
        .then(response => response.json())
        .then(data => {
          namaList = data;
          document.getElementById("loadingNama").style.display = "none";
          document.getElementById("namaUser").disabled = false;
        })
        .catch(() => {
          document.getElementById("loadingNama").innerText = "âŒ Gagal memuat daftar nama!";
          document.getElementById("loadingNama").classList.replace("text-blue-600", "text-red-600");
        });
    }

    function filterNama(input) {
      let listContainer = document.getElementById("autocomplete-list");
      listContainer.innerHTML = "";

      if (!input) return;

      let filteredNama = namaList.filter(nama => nama.toLowerCase().includes(input.toLowerCase()));

      filteredNama.forEach(nama => {
        let div = document.createElement("div");
        div.innerText = nama;
        div.classList.add("px-4", "py-2", "hover:bg-gray-100", "cursor-pointer", "border-b");
        div.addEventListener("click", () => {
          document.getElementById("namaUser").value = nama;
          listContainer.innerHTML = "";
          document.getElementById("absenBtn").disabled = false;
          document.getElementById("tidakHadirBtn").disabled = false;
        });
        listContainer.appendChild(div);
      });
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          userLat = position.coords.latitude;
          userLng = position.coords.longitude;
          document.getElementById("status").innerText = "Lokasi berhasil didapatkan.";
        }, () => {
          document.getElementById("status").innerText = "Gagal mendapatkan lokasi, aktifkan GPS dan refresh halaman ini.";
        });
      } else {
        document.getElementById("status").innerText = "Geolocation tidak didukung.";
      }
    }

    function loadingState(isLoading, btn, defaultText = "Absen Sekarang") {
      if (isLoading) {
        btn.innerText = "Mengirim...";
        btn.disabled = true;
      } else {
        btn.innerText = defaultText;
        btn.disabled = false;
      }
    }

    document.getElementById("namaUser").addEventListener("input", function () {
      filterNama(this.value);
    });

    document.getElementById("absenBtn").addEventListener("click", function () {
      const btn = this;
      const nama = document.getElementById("namaUser").value;
      if (!nama) {
        Swal.fire("Peringatan!", "Silakan pilih nama terlebih dahulu.", "warning");
        return;
      }
      if (!userLat || !userLng) {
        Swal.fire("Peringatan!", "Lokasi tidak tersedia. Silakan aktifkan lokasi di browser dan HP.", "warning").then(() => {
          window.location.reload();
        });
        return;
      }

      loadingState(true, btn);

      fetch(`https://script.google.com/macros/s/AKfycbySsgyPpk2kfol3gWArn5nz0zCn6DnY_xeYqCxvDvwodNTO6xVR2cZ-jAGn0SQk5YFDxA/exec?type=absen&nama=${encodeURIComponent(nama)}&lat=${userLat}&lng=${userLng}`)
        .then(response => response.json())
        .then(data => {
          loadingState(false, btn);
          if (data.success) {
            Swal.fire("Alhamdulillah!", `${nama} berhasil absen!`, "success");
          } else {
            Swal.fire("Gagal!", data.message, "error").then(() => {
              window.location.reload();
            });
          }
        })
        .catch(() => {
          loadingState(false, btn);
          Swal.fire("Error!", "Terjadi kesalahan saat mengirim data!", "error");
        });
    });

    document.getElementById("tidakHadirBtn").addEventListener("click", () => {
      const nama = document.getElementById("namaUser").value;
      if (!nama) {
        Swal.fire("Peringatan!", "Silakan pilih nama terlebih dahulu.", "warning");
        return;
      }

      Swal.fire({
        title: "Pilih Alasan Ketidakhadiran",
        input: "select",
        inputOptions: {
          izin: "Izin",
          sakit: "Sakit"
        },
        inputPlaceholder: "Pilih alasan",
        showCancelButton: true
      }).then((result) => {
        if (result.isConfirmed) {
          let alasan = result.value;
          if (alasan === "izin") {
            Swal.fire({
              title: "Pilih Jenis Izin",
              input: "select",
              inputOptions: {
                "Mengisi kajian": "Mengisi Kajian",
                umroh: "Umroh",
                "Keperluan Keluarga": "Keperluan Keluarga"
              },
              inputPlaceholder: "Pilih jenis izin",
              showCancelButton: true
            }).then((resultJenisIzin) => {
              if (resultJenisIzin.isConfirmed) {
                kirimDataTidakHadir(nama, alasan, resultJenisIzin.value);
              }
            });
          } else {
            kirimDataTidakHadir(nama, alasan, "");
          }
        }
      });
    });

    // Fungsi untuk mengirim data tidak hadir
function kirimDataTidakHadir(nama, alasan, jenisIzin) {
    const btn = document.getElementById("tidakHadirBtn");
    loadingState(true, btn);

    fetch(https://script.google.com/macros/s/AKfycbySsgyPpk2kfol3gWArn5nz0zCn6DnY_xeYqCxvDvwodNTO6xVR2cZ-jAGn0SQk5YFDxA/exec?type=tidakHadir&nama=${encodeURIComponent(nama)}&alasan=${encodeURIComponent(alasan)}&jenisIzin=${encodeURIComponent(jenisIzin)})
        .then(response => response.json())
        .then(data => {
            loadingState(false, btn);
            if (data.success) {
                Swal.fire("Berhasil!", ${nama} tercatat sebagai tidak hadir (${alasan}${jenisIzin ? " - " + jenisIzin : ""})., "success");
            } else {
                Swal.fire("Gagal!", data.message, "error");
            }
        })
        .catch(() => {
            loadingState(false, btn);
            Swal.fire("Error!", "Terjadi kesalahan saat mengirim data!", "error");
        });
}

getNamaDariServer();
getLocation();
  </script>
</body>

</html>
